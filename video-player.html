<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุดุบู ุงูููุฏูู - Top Pharma</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="js/theme.js"></script>
    <script src="js/mobile-nav.js" defer></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">
                ๐ <span>Top Pharma</span>
            </a>
            <ul class="navbar-menu">
                <li><a href="dashboard.html" class="navbar-link">ููุญุฉ ุงูุชุญูู</a></li>
                <li><a href="profile.html" class="navbar-link">ุงูููู ุงูุดุฎุตู</a></li>
                <li><a href="videos.html" class="navbar-link">ุงูููุฏูููุงุช</a></li>
                <li><a href="quizzes.html" class="navbar-link">ุงูุงุฎุชุจุงุฑุงุช</a></li>
                <li><a href="files.html" class="navbar-link">ุงููููุงุช</a></li>
                <li><a href="#" onclick="signOut(); return false;" class="navbar-link btn btn-secondary">ุชุณุฌูู ุงูุฎุฑูุฌ</a></li>
            </ul>
        </div>
    </nav>

    <div id="announcementBanner" class="announcement-banner"></div>

    <!-- Video Player Section -->
    <section class="section">
        <div class="container">
            <a href="videos.html" class="btn btn-outline mb-3">โ ุงูุนูุฏุฉ ููููุฏูููุงุช</a>

            <div class="content-warning-banner" role="alert">
                <div class="content-warning-title">ุชูุจูู ูุงูููู</div>
                <p>
                    ูุฐุง ุงููุญุชูู ูุญูู ุจุญููู ุงููุดุฑ ููุชุงุญ ููุงุณุชุฎุฏุงู ุงูุดุฎุตู ุฏุงุฎู ููุตุฉ Top Pharma ููุท.
                    ููููุน ุชุณุฌูู ุงูุดุงุดุฉ ุฃู ุงููุณุฎ ุฃู ุงููุดุงุฑูุฉ ุฃู ุฅุนุงุฏุฉ ุงููุดุฑ ุจุฃู ูุณููุฉ ุฏูู ุฅุฐู ูุณุจู.
                </p>
            </div>
            
            <div id="loading"></div>
            
            <div id="videoContainer">
                <div class="video-player-container" id="playerWrapper">
                    <video id="videoPlayer" class="video-player" controls width="100%" style="display: none;">
                        ุงููุชุตูุญ ูุง ูุฏุนู ุชุดุบูู ุงูููุฏูู
                    </video>
                    <iframe id="videoFrame" class="video-player" frameborder="0" allowfullscreen style="display: none;"></iframe>
                </div>
                
                <div class="card" style="margin-top: 1.5rem;">
                    <h2 id="videoTitle">ุนููุงู ุงูููุฏูู</h2>
                    <div style="display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
                        <span id="videoCategory" class="category-badge">ุงููุฆุฉ</span>
                        <span id="videoDate" style="color: var(--gray);">ุงูุชุงุฑูุฎ</span>
                    </div>
                    <p id="videoDescription" style="color: var(--gray); line-height: 1.8;">
                        ูุตู ุงูููุฏูู
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div id="suspiciousOverlay" class="content-suspect-overlay" hidden>
        <div class="content-suspect-card">
            <h2>ุชู ุฅููุงู ุนุฑุถ ุงููุญุชูู </h2>
            <p>
                ุชู ุฑุตุฏ ุณููู ูุชูุฑุฑ ูุดูุฑ ุฅูู ูุญุงููุฉ ุชุณุฌูู ุงูุดุงุดุฉ ุฃู ูุบุงุฏุฑุฉ ุงููุงูุฐุฉ ุฃุซูุงุก ุงูุชุดุบูู.
                ุญูุงุธูุง ุนูู ุญููู ุงูููููุฉุ ุชู ุฅุฎูุงุก ุงููุญุชูู ุชููุงุฆููุง.
            </p>
            <p class="content-suspect-note">
             ูุฑุฌู ุงูุงูุชุฒุงู ุจุณูุงุณุฉ ุงูุงุณุชุฎุฏุงู
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>

    <script src="js/videos.js"></script>
    <script src="js/content-protection.js"></script>
    
    <script src="js/announcements.js"></script>
    <script>
        // Protect page and load video
        (async () => {
            const isAuth = await requireAuth();
            if (!isAuth) return;

            const videoId = getQueryParam('id');
            if (!videoId) {
                showError('ุงูููุฏูู ุบูุฑ ููุฌูุฏ');
                setTimeout(() => {
                    window.location.href = 'videos.html';
                }, 2000);
                return;
            }

            const user = await getCurrentUser();
            const profile = user ? await getUserProfile(user.id) : null;
            const userName = profile?.full_name || user?.email || '';
            const userPhone = profile?.phone || '';

            enableContentProtection({
                userName,
                userPhone,
                targetId: 'playerWrapper'
            });

            const suspiciousOverlay = document.getElementById('suspiciousOverlay');
            const detectionThreshold = 3;

            const handleSuspiciousBehavior = () => {
                const videoPlayer = document.getElementById('videoPlayer');
                const videoFrame = document.getElementById('videoFrame');

                if (videoPlayer && !videoPlayer.paused) {
                    videoPlayer.pause();
                }

                if (videoFrame && videoFrame.src) {
                    videoFrame.src = '';
                }

                document.body.classList.add('content-suspect-state');
                if (suspiciousOverlay) {
                    suspiciousOverlay.removeAttribute('hidden');
                }

                if (typeof showToast === 'function') {
                    showToast('ุชู ุฅููุงู ุงููุญุชูู ุจุณุจุจ ุชูุฑุงุฑ ูุญุงููุงุช ูุดุชุจู ุจูุง', 'error');
                }
            };

            if (typeof enableScreenCaptureDetection === 'function') {
                enableScreenCaptureDetection({
                    threshold: detectionThreshold,
                    onAttempt: ({ attempts, threshold }) => {
                        if (typeof showToast === 'function') {
                            showToast(`ุชู ุฑุตุฏ ูุญุงููุฉ ูุดุชุจู ุจูุง (${attempts}/${threshold})`, 'error');
                        }
                    },
                    onThreshold: handleSuspiciousBehavior
                });
            }

            const subjectParam = getQueryParam('subject');

            
            await loadVideo(videoId);
        })();

        async function loadVideo(videoId) {
            showLoading('loading');
            
            try {
                const video = await getVideoById(videoId);
                
                if (!video) {
                    showError('ุงูููุฏูู ุบูุฑ ููุฌูุฏ');
                    setTimeout(() => {
                        window.location.href = 'videos.html';
                    }, 2000);
                    return;
                }


                
                // Update video player
                // Update video player
                const videoUrl = getVideoUrl(video.video_url);
                const videoPlayer = document.getElementById('videoPlayer');
                const videoFrame = document.getElementById('videoFrame');

                if (videoUrl.includes('drive.google.com') || videoUrl.includes('youtube.com') || videoUrl.includes('vimeo')) {
                    videoPlayer.style.display = 'none';
                    videoPlayer.pause();
                    videoFrame.src = videoUrl;
                    videoFrame.style.display = 'block';
                } else {
                    videoFrame.style.display = 'none';
                    videoFrame.src = '';
                    applyVideoElementProtection(videoPlayer);
                    videoPlayer.src = videoUrl;
                    videoPlayer.style.display = 'block';
                }
                
                // Update video info
                document.getElementById('videoTitle').textContent = video.title;
                document.getElementById('videoDescription').textContent = video.description || 'ูุง ููุฌุฏ ูุตู';
                
                const categoryBadge = document.getElementById('videoCategory');
                categoryBadge.textContent = getCategoryName(video.category);
                categoryBadge.className = `category-badge category-${video.category}`;
                
                document.getElementById('videoDate').textContent = formatDate(video.created_at);
                
            } catch (error) {
                console.error('Error loading video:', error);
                showError('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูููุฏูู');
            } finally {
                hideLoading('loading');
            }
        }
    </script>
</body>
</html>
